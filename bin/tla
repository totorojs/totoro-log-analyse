#!/usr/bin/env node

var fs = require('fs')
var path = require('path')
var commander = require('commander')
var colorful = require('colorful')

var server = require('../lib/server')
var logger = require('../lib/logger')()
var dbLog = require('../lib/get-log')()

commander
  .description('totoro server log analyse')
  .option('-v, --version', 'output the version number')
  .option('--verbose', 'show debug log')
  .on('version', function() {
      console.log()
      var pkg = require('../package')
      console.log('  ' + colorful.cyan(pkg.version))
      console.log()
      process.exit(0)
  }).helpInformation = helpInfo


// listen before parse
commander.parse(process.argv)


function helpInfo() {
    var commandHelp = ''
    if (this.commands.length) {
        commandHelp = '\n' +
            colorful.green('  Commands:') +
            '    ' + this.commandHelp().replace(/\n  Commands:\n/gm, '')
    }

    return [
        '',
        colorful.cyan('  ' + this.description()),
        '',
        colorful.green('  Usage:'),
        '    ' + this._name + ' ' + this.usage(),
        commandHelp,
        colorful.green('  Options:'),
        '' + this.optionHelp().replace(/^/gm, '    '),
        '',
        colorful.green('  More Info:'),
        '    ' + colorful.underline('https://github.com/totorojs/totoro-log-analyse'),
        '',
        ''
    ].join('\n')
}

dbLog.init().then(function(models) {
  server.create()
  logger.analyse(models)
})

